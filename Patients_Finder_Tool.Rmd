---
title: "Patients_Finder_Tool"
author: "Phuong Anh Mai"
date: "2024-09-17"
output: html_document
---


```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(patchwork)
library(rpart)
library(readr)
library(dplyr)
library(stringdist)
library(yardstick)
library(gridExtra)
library(patchwork)
library(mulgar)
library(umap)
library(GGally)
library(tourr)
library(ggplot2)
library(kableExtra)
library(knitr)
library(ggfortify)
library(readr)
library(dplyr)
library(magrittr)
library(tidymodels)
library(conflicted)
library(mvtnorm)
library(boot)
library(nullabor)
library(MASS)
library(discrim)
library(parsnip)
library(detourr)
library(crosstalk)
library(colorspace)
library(classifly)
library(plotly)
library(viridis)
library(visdat)
library(cowplot)
library(broom)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::slice)
conflicts_prefer(viridis::viridis_pal)
```

```{r reading datasets, echo = FALSE, warning=FALSE, message = FALSE}
waiting_list <- read_csv("data/new_waiting_list.csv")
theatre_details <- read_csv("data/specific_surgery_details_2023_2024.csv")
inpatient_episode <- read.csv("data/inpatient_episode.csv")
surgery_patients <- read.csv("data/joined_data.csv")

# summary(waiting_list)
# glimpse(waiting_list)
# glimpse(theatre_details)
# glimpse(inpatient_episode)
```

# Assumption
- Get the data from Covid period, the surgery duration is still hold, and it should be the same for other period of time as well.
- Only consider adult patients ( > 17 years old)
- Only case that determined as "Theatre" and without cancellation is listed

# Data wrangling 
```{r splitting, echo = FALSE, warning=FALSE, message=FALSE}
# Data Splitting and Joining 
# theatre_details <- theatre_details %>% 
#  filter(TheatreType == "Theatre")
# Joining inpatient_episode
# waiting_list <- inner_join(waiting_list,
#                           inpatient_episode,
#                           by = "WaitingListId") %>% 
#                select(-WaitingListId, -TheatreCaseId)

# theatre_details <- inner_join(theatre_details,
#                               inpatient_episode,
#                               by = "TheatreCaseId")%>% 
#                select(-WaitingListId, -TheatreCaseId)

# Split into patients had surgery (only `completed` status, ignore other removal reasons) and patients who still waiting
# operated_patients <- waiting_list %>% 
#  filter(RemovalReasonCode == "W")

# Filter out patient > 17 years old
surgery_patients <- surgery_patients %>% 
  filter(AgeAtDateOfRemoval >17)

# Getting waiting list data
waiting_patients <- waiting_list %>% 
  filter(ReportedRemovalDateTime == "NULL",
         RemovalDateTime == "NULL")

# Joining surgery and waiting_list
# surgery_patients <- inner_join(operated_patients,
#                              theatre_details,
#                              by = c("InpatientEpisodeId")) %>% 
#                select(-URNumber.y, -ReferralReceivedDateTime.y, -PlannedTheatreTimeInMins.x, - ReferralSourceRefId.y, -ReferredToHospitalId.y, -ReferralSourceRefId.x)

# Inspect the merged dataset
# glimpse(surgery_patients)
```

# Remove unwanted specialty (recheck)
unwanted_specialty <- c("Breast Surgery", 
                        "CC Breast Surgery",
                        "CC Colorectal",
                        "Colorectal Surgery",
                        "CC Endocrine Surgery",
                        "Endocrine Surgery",
                        "CC ENT Surgery",
                        "ENT Surgery",
                        "Paed ENT",
                        "CC Gastroenterology",
                        "Endoscopy - Gen Surg",
                        "Gastro Surgery",
                        "Gastroenterology",
                        "CC General Surgery",
                        "General Surgery",
                        "CC Neurosurgery",
                        "Neurosurgery",
                        "Paed Neurosurg",
                        "CC Ophthalmology",
                        "Ophthalmology",
                        "Paed Ophthalmology",
                        "CC Maxillofacial Surgery",
                        "Oral & Max-facial Surgery",
                        "Paed Oral & Maxillofacial Surgery",
                        "CC Orthopaedic Surgery",
                        "Orthopaedic Surgery",
                        "Paed Orthopaedic Surgery",
                        "Paed General Surgery",
                        "Paed Urology",
                        "Paed Gastro Surgery",
                        "CC Plastics",
                        "Paed Plastic Surgery",
                        "Plastic Surgery",
                        "Renal Surgery",
                        "CC Upper GI",
                        "Metabolic Surgery", 
                        "Upper GI Surgery",
                        "CC Urology",
                        "Urology",
                        "CC Vascular",
                        "Vascular Surgery",
                        "Cardiology",
                        "Cardiothoracic Surgery",
                        "Rheumatology",
                        "Diagnostic Imaging",
                        "Respiratory Medicine",
                        "Paed Dental Surgery")

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted_specialty, ]
 
```{r wrangling, echo = FALSE, warning=FALSE, message=FALSE}
# Remove or impute missing data 
surgery_patients <- na.omit(surgery_patients)
# waiting_patients <- na.omit(waiting_patients) # recheck, remove na remove all rows

# surgery_patients <- read_csv("data/surgery_patients.csv")

# Select relevant columns based on the provided data
# surgery_patients <- surgery_patients %>%
#   select(OperatingDrCarerName, WaitingListSpecialtyDesc, inpatient_episode_identifier,
#         ArrivedTheatreDateTime, OutOfTheatreDateTime, PlannedTheatreTimeInMins.y, WaitingStartDateTime,SurgeryStartDateTime, SurgeryEndDateTime, TotalWaitingDays, TreatmentCampusName, ReferredToHospitalName, CountEpisodes)

# Remove unwanted columns
unwanted <- c("Paed ENT",
"Paed General Surgery",
"Paed Oral & Maxillofacial Surgery",
"Paed Orthopaedic Surgery",
"Paed Plastic Surgery",
"Paed Urology")

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted, ]

# Remove duplicate
# Identify duplicates
duplicates <- duplicated(surgery_patients)
# Remove duplicates
surgery_patients <- surgery_patients[!duplicated(surgery_patients), ]

# Convert data types
surgery_patients$PlannedTheatreTimeInMins <- as.numeric(surgery_patients$PlannedTheatreTimeInMins)
surgery_patients$WaitingListSpecialtyDesc <- as.factor(surgery_patients$WaitingListSpecialtyDesc)
surgery_patients$inpatient_episode_identifier <- as.factor(surgery_patients$inpatient_episode_identifier)
surgery_patients$OperatingDrCarerName <- as.factor(surgery_patients$OperatingDrCarerName)
surgery_patients$ArrivedTheatreDateTime <- as.POSIXct(surgery_patients$ArrivedTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$OutOfTheatreDateTime <- as.POSIXct(surgery_patients$OutOfTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$WaitingStartDateTime <- as.POSIXct(surgery_patients$WaitingStartDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$SurgeryStartDateTime <- as.POSIXct(surgery_patients$SurgeryStartDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$SurgeryEndDateTime <- as.POSIXct(surgery_patients$SurgeryEndDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$IntoTheatreDateTime <- as.POSIXct(surgery_patients$IntoTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$OutOfTheatreDateTime <- as.POSIXct(surgery_patients$OutOfTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")

# glimpse(surgery_patients)
```

# Feature engineering
# Extract interesting features

```{r surgery length}
# Calculate real-time of surgery
surgery_patients <- surgery_patients %>% 
  mutate(SurgeryLength = round((difftime(OutOfTheatreDateTime, IntoTheatreDateTime, units = "mins")),4)) %>% 
  mutate(SurgeryLength = as.numeric((SurgeryLength)))

# Check data created
# summary(surgery_patients$SurgeryLength)
# Remove negative values and outliers
surgery_patients <- surgery_patients %>% 
  na.omit() %>% 
  filter(SurgeryLength > 10) %>% 
  filter(SurgeryLength < 600) %>% 
  filter(PlannedTheatreTimeInMins > 10) %>% 
  filter(PlannedTheatreTimeInMins < 600)
```

```{r}
# Calculating Average Surgery Length by Age Group
AverageSurgeryLength_age <- surgery_patients %>% 
  group_by(AgeGroupAtDateOfRemoval) %>% 
  summarise(AverageSurgeryLength_age = round(mean(SurgeryLength, na.rm = TRUE)))

# Displaying the result
AverageSurgeryLength_age %>%
  kable("html", caption = "Average Surgery Length by Age Group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Length" = 1))  
```


```{r}
# Calculate the average of SurgeryLength by specialty
average_surgery_length <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))

# Displaying the result
average_surgery_length %>%
  kable("html", caption = "Average Surgery Length by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Length" = 1))  
```

Filter out Surgery within 10 hours, as the longer surgery requested more complex estimation.
```{r}
# Calculating Waiting day variables and creating category for each group
surgery_patients <- surgery_patients %>%
  mutate(WaitingDays = as.numeric(round(difftime(SurgeryStartDateTime, WaitingStartDateTime, units = "days")))) %>%
  mutate(WaitingCategory = case_when(
    WaitingDays <= 30 ~ "Short",
    WaitingDays > 30 & WaitingDays <= 90 ~ "Medium",
    WaitingDays > 90 ~ "Long"
  ))

# Displaying the result
surgery_patients$WaitingCategory %>%
  head(10)
```

```{r}
# Proportion under 1 year by Specialty
proportion_within_1_year_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Proportion = mean(WaitingDays <= 365))

proportion_within_1_year_by_specialty
```

```{r}
# Average waiting time for particular Specialty
Average_waiting_day_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Avearge_waiting_day = round(mean(WaitingDays)),
            CaseCount = n()) 

# Filter out significant case
Average_waiting_day_by_specialty <- Average_waiting_day_by_specialty %>% 
  filter(CaseCount > 10)

# Displaying the result
Average_waiting_day_by_specialty %>%
  kable("html", caption = "Average Waiting Days by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Waiting Days" = 1, "Number of Case" = 1))  
```

```{r}
# Calculate average surgeons operating time
average_surgery_length_surgeons <- surgery_patients %>%
  group_by(OperatingDrCarerName) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))
```

# Exploratory Data Analysis (EDA)
## Checking the completeness of the data.
```{r}
p1 <- vis_dat(surgery_patients, `warn_large_data` = FALSE)

p2 <- vis_dat(waiting_patients, `warn_large_data` = FALSE)

plot_grid(p1, p2) 
```


```{r visualize, echo = FALSE, warning=FALSE, message=FALSE}
# Visualize the distribution of Planned Theatre Time
a <- ggplot(surgery_patients, aes(x = PlannedTheatreTimeInMins)) +
  geom_histogram(fill = "blue", color = "white", bins = 30) +
  theme_minimal() +
  labs(title = "Distribution of Planned Theatre Time in Minutes",
       x = "Planned Theatre Time (mins)")

# Visualize the distribution of Time Difference
b <- ggplot(surgery_patients, aes(x = SurgeryLength)) +
  geom_histogram( fill = "pink", color = "white", bins = 30) +
  theme_minimal() +
  labs(title = "Distribution of Surgery Time in Minutes",
       x = "Operating Theatre Time (mins)")

gridExtra::grid.arrange(a, b)
```
**Insights**
Most case within range under 250, just a few outliers that are outside this range. Our goal is to improve this Planned Theatre Case.

```{r echo = FALSE, warning=FALSE, message=FALSE}
# Investigate relationships between Specialty and SurgeryLength
ggplot() +
  # Add geom_line using the average surgery length by specialty
  geom_line(data = average_surgery_length, aes(x = AverageSurgeryLength, 
                                               y = fct_reorder(WaitingListSpecialtyDesc, AverageSurgeryLength),
                                               group = 1), color = "blue", size = 1) +
   theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 55, hjust = 1)) +
  labs(title = "Average Surgery Length by Specialty",
       x = "Average Surgery Length (mins)",
       y = "Specialty")

# Boxplot of SurgeryLength with an additional geom_line for average
ggplot(surgery_patients, aes(x = SurgeryLength, y = fct_reorder(WaitingListSpecialtyDesc, SurgeryLength, .fun = median))) +
  geom_boxplot(fill = "pink") +
  
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 55, hjust = 1)) +
  labs(title = "Surgery Length by Specialty",
       x = "Surgery Length (mins)",
       y = "Specialty")

```

```{r echo = FALSE, warning=FALSE, message=FALSE}
# Proportion of people in waiting within 1 year
proportion_within_1_year <- surgery_patients %>%
  summarise(Proportion = mean(WaitingDays <= 365))

proportion_within_1_year
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
ggplot(proportion_within_1_year_by_specialty, aes(x = reorder(WaitingListSpecialtyDesc, Proportion), y = Proportion)) +
  geom_segment(aes(xend = reorder(WaitingListSpecialtyDesc, Proportion), y = 0, yend = Proportion), color = "grey") +
  geom_point(size = 5, color = "lightblue") +
  theme_minimal() +
  labs(title = "Proportion of Patients Waiting Under 1 Year by Specialty",
       x = "Specialty",
       y = "Proportion") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))

# fpp3::autoplot(proportion_within_1_year_by_specialty)
```

```{r avg_waiting_day, echo = FALSE, warning=FALSE, message=FALSE}
# Selected case 
Selected_case <- Average_waiting_day_by_specialty %>%
  pull(WaitingListSpecialtyDesc)

# Use case count to eliminate the Specialty with too low observation
surgery_patients <- surgery_patients %>% 
  filter(WaitingListSpecialtyDesc %in% Selected_case)

p <- ggplot(Average_waiting_day_by_specialty, aes(x = reorder(WaitingListSpecialtyDesc, Avearge_waiting_day), y = Avearge_waiting_day)) +
  geom_segment(aes(xend = reorder(WaitingListSpecialtyDesc, Avearge_waiting_day), y = 0, yend = Avearge_waiting_day), color = "grey") +
  geom_point(aes(size = CaseCount), color = "lightblue")  +
  theme_minimal() +
  labs(title = "Average Waiting Day by Specialty",
       x = "Specialty",
       y = "Avearge waiting day") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))

plotly_plot <- ggplotly(p)

plotly_plot
```

Outlier: Paed Plastic Surgery

# Model fitting
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Get all levels of the factor from the entire dataset
all_levels <- levels(factor(surgery_patients$WaitingListSpecialtyDesc))

# Set the levels for the factor in the dataset
surgery_patients$WaitingListSpecialtyDesc <- factor(surgery_patients$WaitingListSpecialtyDesc, levels = all_levels)

# Training and Testing sets
# surgery_patients_split <- initial_split(surgery_patients,
#                                        2/3,
#                                        strata = WaitingListSpecialtyDesc)

# train_data <- training(surgery_patients_split)
# test_data <- testing(surgery_patients_split)

# Creating Cross validation folds
set.seed(123)
surgery_folds <- vfold_cv(surgery_patients, v = 5, strata = WaitingListSpecialtyDesc)
```
```{r recipe, eval = FALSE}
surgery_recipe <- recipe(SurgeryLength ~ AgeGroupAtDateOfRemoval + CurrentPriorityCode + WaitingListSpecialtyDesc +
                           NumberOfSurgeries + WaitingDays + WaitingCategory, data = train_data) %>%
  step_dummy(all_nominal_predictors()) %>%  # Convert factors to dummy variables
  step_normalize(all_numeric_predictors())  # Normalize numeric predictors for lm model
```

```{r}
# Fitting the model
# Linear Regression
lr_spec <- linear_reg() %>%
  set_engine("lm")

# Random Forest
rf_spec <- rand_forest(mtry = tune(), trees = 500, min_n = tune()) %>%
  set_engine("ranger") %>%
  set_mode("regression")

# Gradient Boosting
gbm_spec <- boost_tree(mtry = tune(), trees = 500, learn_rate = 0.01 #Controls how much each tree contributes to the final model in boosting algorithm
                       ) %>%
  set_engine("xgboost") %>%
  set_mode("regression")
```

```{r}
# Linear Regression Workflow
lr_workflow <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(surgery_recipe)

# Random Forest Workflow
rf_workflow <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(surgery_recipe)

# Gradient Boosting Workflow
gbm_workflow <- workflow() %>%
  add_model(gbm_spec) %>%
  add_recipe(surgery_recipe)
```

```{r}
# Setting Hyperparameters tune
# Random Forest Tuning Grid
rf_grid <- grid_regular(
  mtry(range = c(2, 10)),
  min_n(range = c(5, 15)),
  levels = 5
)

# Gradient Boosting Tuning Grid
gbm_grid <- grid_regular(
  mtry(range = c(2, 10)),
  levels = 5
)
```


```{r}
# Fit Linear Regression with Cross-Validation
lr_results <- fit_resamples(
  lr_workflow,
  resamples = surgery_folds,
  metrics = metric_set(rmse),
  control = control_resamples(save_pred = TRUE)
)


# Tune Random Forest Model
rf_results <- tune_grid(
  rf_workflow,
  resamples = surgery_folds,
  grid = rf_grid,
  metrics = metric_set(rmse),
  control = control_grid(save_pred = TRUE)
)

# Select Best Hyperparameters
best_rf <- select_best(rf_results, "rmse")

# Finalize Workflow with Best Hyperparameters
final_rf_workflow <- finalize_workflow(rf_workflow, best_rf)

# Tune Gradient Boosting Model
gbm_results <- tune_grid(
  gbm_workflow,
  resamples = surgery_folds,
  grid = gbm_grid,
  metrics = metric_set(rmse),
  control = control_grid(save_pred = TRUE)
)

# Select Best Hyperparameters
best_gbm <- select_best(gbm_results, "rmse")

# Finalize Workflow with Best Hyperparameters
final_gbm_workflow <- finalize_workflow(gbm_workflow, best_gbm)

```

```{r}
# Collect RMSE Metrics
lr_rmse <- lr_results %>% collect_metrics()
rf_rmse <- rf_results %>% collect_metrics()
gbm_rmse <- gbm_results %>% collect_metrics()
```

```{r}
# Combine RMSE Results
rmse_results <- bind_rows(
  lr_rmse %>% mutate(Model = "Linear Regression"),
  rf_rmse %>% mutate(Model = "Random Forest"),
  gbm_rmse %>% mutate(Model = "Gradient Boosting")
)

# View RMSE Comparison
rmse_results %>%
  select(Model, .metric, mean, std_err) %>%
  arrange(mean) %>%
  kable("html", caption = "Model RMSE Comparison") %>%
  kable_styling(full_width = FALSE)
```

```{r old_one}
# Temporarily error, recheck
#Recheck
surgery_metrics_wide <- surgery_metrics %>% 
  select(id, log_metrics, ridge_metrics, lasso_metrics, rf_metrics, gbm_metrics) %>% 
  unnest(cols = c(log_metrics, ridge_metrics, lasso_metrics, rf_metrics, gbm_metrics), names_sep = "_") %>%
  
  pivot_longer(cols = starts_with("reg_metrics_"), names_to = "metric", names_prefix = "reg_metrics_", values_to = "reg") %>%
  pivot_longer(cols = starts_with("ridge_metrics_"), names_to = "metric", names_prefix = "ridge_metrics_", values_to = "ridge") %>%
  pivot_longer(cols = starts_with("lasso_metrics_"), names_to = "metric", names_prefix = "lasso_metrics_", values_to = "lasso") %>%
  pivot_longer(cols = starts_with("rf_metrics_"), names_to = "metric", names_prefix = "rf_metrics_", values_to = "rf") %>%
  pivot_longer(cols = starts_with("gbm_metrics_"), names_to = "metric", names_prefix = "gbm_metrics_", values_to = "gbm") %>%
  pivot_longer(cols = c(log, ridge, lasso, rf, gbm), names_to = "model", values_to = "value") %>%
  pivot_wider(names_from = metric, values_from = value)

# Calculate average metrics across folds for each model
surgery_results <- surgery_metrics_wide %>% 
  group_by(model) %>% 
  summarize(
    rmse = mean(rmse, na.rm = TRUE),
    mae = mean(mae, na.rm = TRUE),
    mape = mean(mape, na.rm = TRUE),
    rsq = mean(rsq, na.rm = TRUE)
  )

print(surgery_results)
```

