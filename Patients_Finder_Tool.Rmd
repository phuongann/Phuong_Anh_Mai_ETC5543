---
title: "Patients_Finder_Tool"
author: "Phuong Anh Mai"
date: "2024-09-17"
output: html_document
---


```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(patchwork)
library(rpart)
library(readr)
library(dplyr)
library(stringdist)
library(yardstick)
library(gridExtra)
library(patchwork)
library(mulgar)
library(umap)
library(GGally)
library(tourr)
library(ggplot2)
library(kableExtra)
library(knitr)
library(ggfortify)
library(readr)
library(dplyr)
library(magrittr)
library(tidymodels)
library(conflicted)
library(mvtnorm)
library(boot)
library(nullabor)
library(MASS)
library(discrim)
library(parsnip)
library(detourr)
library(crosstalk)
library(colorspace)
library(classifly)
library(plotly)
library(viridis)
library(visdat)
library(cowplot)
library(broom)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::slice)
conflicts_prefer(viridis::viridis_pal)
```

```{r reading datasets, echo = FALSE, warning=FALSE, message = FALSE}
waiting_list <- read_csv("data/new_waiting_list.csv")
theatre_details <- read_csv("data/specific_surgery_details_2023_2024.csv")
inpatient_episode <- read.csv("data/inpatient_episode.csv")
surgery_patients <- read.csv("data/joined_data.csv")

# summary(waiting_list)
# glimpse(waiting_list)
# glimpse(theatre_details)
# glimpse(inpatient_episode)
```

# Assumption
- Get the data from Covid period, the surgery duration is still hold, and it should be the same for other period of time as well.
- Only consider adult patients ( > 17 years old)
- Only case that determined as "Theatre" and without cancellation is listed

# Data wrangling 
```{r splitting, echo = FALSE, warning=FALSE, message=FALSE}
# Data Splitting and Joining 
# theatre_details <- theatre_details %>% 
#  filter(TheatreType == "Theatre")
# Joining inpatient_episode
# waiting_list <- inner_join(waiting_list,
#                           inpatient_episode,
#                           by = "WaitingListId") %>% 
#                select(-WaitingListId, -TheatreCaseId)

# theatre_details <- inner_join(theatre_details,
#                               inpatient_episode,
#                               by = "TheatreCaseId")%>% 
#                select(-WaitingListId, -TheatreCaseId)

# Split into patients had surgery (only `completed` status, ignore other removal reasons) and patients who still waiting
# operated_patients <- waiting_list %>% 
#  filter(RemovalReasonCode == "W")

# Filter out patient > 17 years old
surgery_patients <- surgery_patients %>% 
  filter(AgeAtDateOfRemoval >17)

# Getting waiting list data
waiting_patients <- waiting_list %>% 
  filter(ReportedRemovalDateTime == "NULL",
         RemovalDateTime == "NULL")

# Joining surgery and waiting_list
# surgery_patients <- inner_join(operated_patients,
#                              theatre_details,
#                              by = c("InpatientEpisodeId")) %>% 
#                select(-URNumber.y, -ReferralReceivedDateTime.y, -PlannedTheatreTimeInMins.x, - ReferralSourceRefId.y, -ReferredToHospitalId.y, -ReferralSourceRefId.x)

# Inspect the merged dataset
# glimpse(surgery_patients)
```

# Remove unwanted specialty (recheck)
unwanted_specialty <- c("Breast Surgery", 
                        "CC Breast Surgery",
                        "CC Colorectal",
                        "Colorectal Surgery",
                        "CC Endocrine Surgery",
                        "Endocrine Surgery",
                        "CC ENT Surgery",
                        "ENT Surgery",
                        "Paed ENT",
                        "CC Gastroenterology",
                        "Endoscopy - Gen Surg",
                        "Gastro Surgery",
                        "Gastroenterology",
                        "CC General Surgery",
                        "General Surgery",
                        "CC Neurosurgery",
                        "Neurosurgery",
                        "Paed Neurosurg",
                        "CC Ophthalmology",
                        "Ophthalmology",
                        "Paed Ophthalmology",
                        "CC Maxillofacial Surgery",
                        "Oral & Max-facial Surgery",
                        "Paed Oral & Maxillofacial Surgery",
                        "CC Orthopaedic Surgery",
                        "Orthopaedic Surgery",
                        "Paed Orthopaedic Surgery",
                        "Paed General Surgery",
                        "Paed Urology",
                        "Paed Gastro Surgery",
                        "CC Plastics",
                        "Paed Plastic Surgery",
                        "Plastic Surgery",
                        "Renal Surgery",
                        "CC Upper GI",
                        "Metabolic Surgery", 
                        "Upper GI Surgery",
                        "CC Urology",
                        "Urology",
                        "CC Vascular",
                        "Vascular Surgery",
                        "Cardiology",
                        "Cardiothoracic Surgery",
                        "Rheumatology",
                        "Diagnostic Imaging",
                        "Respiratory Medicine",
                        "Paed Dental Surgery")

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted_specialty, ]
 
```{r wrangling, echo = FALSE, warning=FALSE, message=FALSE}
# Remove or impute missing data 
surgery_patients <- na.omit(surgery_patients)
# waiting_patients <- na.omit(waiting_patients) # recheck, remove na remove all rows

# surgery_patients <- read_csv("data/surgery_patients.csv")

# Select relevant columns based on the provided data
# surgery_patients <- surgery_patients %>%
#   select(OperatingDrCarerName, WaitingListSpecialtyDesc, inpatient_episode_identifier,
#         ArrivedTheatreDateTime, OutOfTheatreDateTime, PlannedTheatreTimeInMins.y, WaitingStartDateTime,SurgeryStartDateTime, SurgeryEndDateTime, TotalWaitingDays, TreatmentCampusName, ReferredToHospitalName, CountEpisodes)

# Remove unwanted columns
unwanted <- c("Paed ENT",
"Paed General Surgery",
"Paed Oral & Maxillofacial Surgery",
"Paed Orthopaedic Surgery",
"Paed Plastic Surgery",
"Paed Urology")

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted, ]

# Remove duplicate
# Identify duplicates
duplicates <- duplicated(surgery_patients)
# Remove duplicates
surgery_patients <- surgery_patients[!duplicated(surgery_patients), ]

# Convert data types
surgery_patients$PlannedTheatreTimeInMins <- as.numeric(surgery_patients$PlannedTheatreTimeInMins)
surgery_patients$WaitingListSpecialtyDesc <- as.factor(surgery_patients$WaitingListSpecialtyDesc)
surgery_patients$inpatient_episode_identifier <- as.factor(surgery_patients$inpatient_episode_identifier)
surgery_patients$OperatingDrCarerName <- as.factor(surgery_patients$OperatingDrCarerName)
surgery_patients$ArrivedTheatreDateTime <- as.POSIXct(surgery_patients$ArrivedTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$OutOfTheatreDateTime <- as.POSIXct(surgery_patients$OutOfTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$WaitingStartDateTime <- as.POSIXct(surgery_patients$WaitingStartDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$SurgeryStartDateTime <- as.POSIXct(surgery_patients$SurgeryStartDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$SurgeryEndDateTime <- as.POSIXct(surgery_patients$SurgeryEndDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$IntoTheatreDateTime <- as.POSIXct(surgery_patients$IntoTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")
surgery_patients$OutOfTheatreDateTime <- as.POSIXct(surgery_patients$OutOfTheatreDateTime, format = "%Y-%m-%d %H:%M:%S")

# glimpse(surgery_patients)
```

# Feature engineering
# Extract interesting features

```{r surgery length}
# Calculate real-time of surgery
surgery_patients <- surgery_patients %>% 
  mutate(SurgeryLength = round((difftime(OutOfTheatreDateTime, IntoTheatreDateTime, units = "mins")),4)) %>% 
  mutate(SurgeryLength = as.numeric((SurgeryLength)))

# Check data created
# summary(surgery_patients$SurgeryLength)
# Remove negative values and outliers
surgery_patients <- surgery_patients %>% 
  na.omit() %>% 
  filter(SurgeryLength > 10) %>% 
  filter(SurgeryLength < 600) %>% 
  filter(PlannedTheatreTimeInMins > 10) %>% 
  filter(PlannedTheatreTimeInMins < 600)
```

```{r}
# Calculating Average Surgery Length by Age Group
AverageSurgeryLength_age <- surgery_patients %>% 
  group_by(AgeGroupAtDateOfRemoval) %>% 
  summarise(AverageSurgeryLength_age = round(mean(SurgeryLength, na.rm = TRUE)))

# Displaying the result
AverageSurgeryLength_age %>%
  kable("html", caption = "Average Surgery Length by Age Group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Length" = 1))  
```


```{r}
# Calculate the average of SurgeryLength by specialty
average_surgery_length <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))

# Displaying the result
average_surgery_length %>%
  kable("html", caption = "Average Surgery Length by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Length" = 1))  
```

Filter out Surgery within 10 hours, as the longer surgery requested more complex estimation.
```{r}
# Calculating Waiting day variables and creating category for each group
surgery_patients <- surgery_patients %>%
  mutate(WaitingDays = as.numeric(round(difftime(SurgeryStartDateTime, WaitingStartDateTime, units = "days")))) %>%
  mutate(WaitingCategory = case_when(
    WaitingDays <= 30 ~ "Short",
    WaitingDays > 30 & WaitingDays <= 90 ~ "Medium",
    WaitingDays > 90 ~ "Long"
  ))

# Displaying the result
surgery_patients$WaitingCategory %>%
  head(10)
```

```{r}
# Proportion under 1 year by Specialty
proportion_within_1_year_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Proportion = mean(WaitingDays <= 365))

proportion_within_1_year_by_specialty
```

```{r}
# Average waiting time for particular Specialty
Average_waiting_day_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Avearge_waiting_day = round(mean(WaitingDays)),
            CaseCount = n()) 

# Filter out significant case
Average_waiting_day_by_specialty <- Average_waiting_day_by_specialty %>% 
  filter(CaseCount > 10)

# Displaying the result
Average_waiting_day_by_specialty %>%
  kable("html", caption = "Average Waiting Days by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Waiting Days" = 1, "Number of Case" = 1))  
```

```{r}
# Calculate average surgeons operating time
average_surgery_length_surgeons <- surgery_patients %>%
  group_by(OperatingDrCarerName) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))
```

# Exploratory Data Analysis (EDA)
## Checking the completeness of the data.
```{r}
p1 <- vis_dat(surgery_patients, `warn_large_data` = FALSE)

p2 <- vis_dat(waiting_patients, `warn_large_data` = FALSE)

plot_grid(p1, p2) 
```