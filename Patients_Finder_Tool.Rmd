---
title: "Patients_Finder_Tool"
author: "Phuong Anh Mai"
date: "2024-09-17"
output: html_document
---

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(patchwork)
library(rpart)
library(readr)
library(dplyr)
library(stringdist)
library(yardstick)
library(gridExtra)
library(patchwork)
library(mulgar)
library(umap)
library(GGally)
library(tourr)
library(ggplot2)
library(kableExtra)
library(knitr)
library(ggfortify)
library(readr)
library(dplyr)
library(magrittr)
library(tidymodels)
library(conflicted)
library(mvtnorm)
library(boot)
library(nullabor)
library(MASS)
library(discrim)
library(parsnip)
library(detourr)
library(crosstalk)
library(colorspace)
library(classifly)
library(plotly)
library(viridis)
library(visdat)
library(cowplot)
library(broom)
library(tidymodels)
library(randomForest)
library(gbm)
library(purrr)
library(themis)
library(glmnet)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::slice)
conflicts_prefer(viridis::viridis_pal)
```

```{r reading datasets, echo = FALSE, warning=FALSE, message = FALSE}
waiting_list <- read_csv("data/new_waiting_list.csv")
surgery_patients <- read.csv("data/joined_data.csv")

# summary(waiting_list)
# glimpse(waiting_list)
# glimpse(surgery_patients)
```

# Assumption
- Get the data from Covid period, the surgery duration is still hold, and it should be the same for other period of time as well.
- Only consider adult patients ( > 17 years old)
- Only case that determined as "Theatre" and without cancellation is listed


# Data wrangling 
```{r wrangling, echo = FALSE, warning=FALSE, message=FALSE}
# Filter out patient > 17 years old
surgery_patients <- surgery_patients %>% 
  filter(AgeAtDateOfRemoval >17)

# Getting waiting list data
waiting_patients <- waiting_list %>% 
  filter(ReportedRemovalDateTime == "NULL",
         RemovalDateTime == "NULL")

# Remove or impute missing data 
surgery_patients <- na.omit(surgery_patients)

# Remove unwanted columns
unwanted <- c("Paed ENT",
"Paed General Surgery",
"Paed Oral & Maxillofacial Surgery",
"Paed Orthopaedic Surgery",
"Paed Plastic Surgery",
"Paed Urology")

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted, ]

# Remove duplicate
# Identify duplicates
duplicates <- duplicated(surgery_patients)
# Remove duplicates
surgery_patients <- surgery_patients[!duplicated(surgery_patients), ]

# glimpse(surgery_patients)

# Create PPPCategory for both datasets
surgery_patients <- surgery_patients %>%
  mutate(PPPCategory = case_when(
    grepl("arthro|joint|shoulder|knee|ligament|rotator cuff|ACL|hip|meniscus|spine|fusion|discectomy", 
          PPPDesc, ignore.case = TRUE) ~ "Orthopedic",
    grepl("heart|cardiac|bypass|coronary|valve|CABG|aortic|angioplasty|stent|aneurysm", 
          PPPDesc, ignore.case = TRUE) ~ "Cardiac",
    grepl("appendic|cholecyst|bowel|hernia|gastrectomy|colectomy|colorectal|laparotomy|gastrostomy|fundoplication", 
          PPPDesc, ignore.case = TRUE) ~ "General Surgery",
    grepl("breast|mastectomy|lumpectomy|reconstruction|augmentation|reduction|prosthesis|biopsy|oncology", 
          PPPDesc, ignore.case = TRUE) ~ "Breast Surgery",
    grepl("urology|kidney|nephrectomy|bladder|prostate|ureter|urethra|renal", 
          PPPDesc, ignore.case = TRUE) ~ "Urology",
    grepl("ENT|sinus|tonsil|adenoid|larynx|otoplasty|nose|nasal|septoplasty|ear|throat", 
          PPPDesc, ignore.case = TRUE) ~ "ENT Surgery",
    grepl("gynaecology|hysterectomy|cervix|uterus|fallopian|ovary|endometrial|ablation|vaginal", 
          PPPDesc, ignore.case = TRUE) ~ "Gynaecology",
    grepl("neurosurgery|brain|craniotomy|spinal|meninges|nerve|tumor|neuro", 
          PPPDesc, ignore.case = TRUE) ~ "Neurosurgery",
    TRUE ~ "Other"  # Default category if none of the above matches
  ))


waiting_list <- waiting_list %>%
  mutate(PPPCategory = case_when(
    grepl("arthro|joint|shoulder|knee|ligament|rotator cuff|ACL|hip|meniscus|spine|fusion|discectomy", 
          PPPDesc, ignore.case = TRUE) ~ "Orthopedic",
    grepl("heart|cardiac|bypass|coronary|valve|CABG|aortic|angioplasty|stent|aneurysm", 
          PPPDesc, ignore.case = TRUE) ~ "Cardiac",
    grepl("appendic|cholecyst|bowel|hernia|gastrectomy|colectomy|colorectal|laparotomy|gastrostomy|fundoplication", 
          PPPDesc, ignore.case = TRUE) ~ "General Surgery",
    grepl("breast|mastectomy|lumpectomy|reconstruction|augmentation|reduction|prosthesis|biopsy|oncology", 
          PPPDesc, ignore.case = TRUE) ~ "Breast Surgery",
    grepl("urology|kidney|nephrectomy|bladder|prostate|ureter|urethra|renal", 
          PPPDesc, ignore.case = TRUE) ~ "Urology",
    grepl("ENT|sinus|tonsil|adenoid|larynx|otoplasty|nose|nasal|septoplasty|ear|throat", 
          PPPDesc, ignore.case = TRUE) ~ "ENT Surgery",
    grepl("gynaecology|hysterectomy|cervix|uterus|fallopian|ovary|endometrial|ablation|vaginal", 
          PPPDesc, ignore.case = TRUE) ~ "Gynaecology",
    grepl("neurosurgery|brain|craniotomy|spinal|meninges|nerve|tumor|neuro", 
          PPPDesc, ignore.case = TRUE) ~ "Neurosurgery",
    TRUE ~ "Other"  # Default category 
  ))

# Convert data types
surgery_patients <- surgery_patients %>%
  mutate(
    PlannedTheatreTimeInMins = as.numeric(PlannedTheatreTimeInMins),
    ArrivedTheatreDateTime = as.POSIXct(ArrivedTheatreDateTime, format = "%Y-%m-%d %H:%M:%S"),
    OutOfTheatreDateTime = as.POSIXct(OutOfTheatreDateTime, format = "%Y-%m-%d %H:%M:%S"),
    WaitingStartDateTime = as.POSIXct(WaitingStartDateTime, format = "%Y-%m-%d %H:%M:%S"),
    SurgeryStartDateTime = as.POSIXct(SurgeryStartDateTime, format = "%Y-%m-%d %H:%M:%S"),
    SurgeryEndDateTime = as.POSIXct(SurgeryEndDateTime, format = "%Y-%m-%d %H:%M:%S"),
    IntoTheatreDateTime = as.POSIXct(IntoTheatreDateTime, format = "%Y-%m-%d %H:%M:%S"),
    AgeGroupAtDateOfRemoval = as.factor(AgeGroupAtDateOfRemoval),
    CurrentPriorityCode = as.factor(CurrentPriorityCode),
    PPPCategory = as.factor(PPPCategory),
    # Use for model fitting
    WaitingListSpecialtyDesc = as.factor(WaitingListSpecialtyDesc),
    OperatingDrCarerName = as.factor(OperatingDrCarerName),
    TreatmentCampusName = as.factor(TreatmentCampusName),
    PlannedStayTypeDescription = as.factor(PlannedStayTypeDescription),
    AdminCategory = as.factor(AdminCategory),
    # inpatient_episode_identifier = as.factor(inpatient_episode_identifier),
    # PPPDesc = as.factor(PPPDesc),
    # NumberOfSurgeries = as.numeric(NumberOfSurgeries),
    # WaitingDays = as.numeric(WaitingDays)
  )

# Calculate real-time of surgery
surgery_patients <- surgery_patients %>% 
  mutate(SurgeryLength = round((difftime(OutOfTheatreDateTime, IntoTheatreDateTime, units = "mins")),4)) %>% 
  mutate(SurgeryLength = as.numeric((SurgeryLength)))

# Create Surgery Length
surgery_patients <- surgery_patients %>%
mutate(SurgeryLength = as.numeric(SurgeryLength))

waiting_list <- waiting_list %>%
  mutate(
    AgeGroupAtDateOfRemoval = as.factor(AgeGroupAtDateOfRemoval),
    CurrentPriorityCode = as.factor(CurrentPriorityCode),
    WaitingListSpecialtyDesc = as.factor(WaitingListSpecialtyDesc),
    PPPCategory = as.factor(PPPCategory),
    # PPPDesc = as.factor(PPPDesc),
    TreatmentCampusName = as.factor(TreatmentCampusName),
    PlannedStayTypeDescription = as.factor(PlannedStayTypeDescription),
    AdminCategory = as.factor(AdminCategory)
    # NumberOfSurgeries = as.numeric(NumberOfSurgeries),
    # WaitingDays = as.numeric(WaitingDays)
  )
```


# Feature engineering
# Extract interesting features

```{r surgery length}
# Remove Specialty with under 10 cases
unwanted_specialty<- surgery_patients %>% 
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(CaseCount = n()) %>% 
  filter(CaseCount < 10)

surgery_patients <- surgery_patients[!surgery_patients$WaitingListSpecialtyDesc %in% unwanted_specialty$WaitingListSpecialtyDesc, ]

# Check data created
# summary(surgery_patients$SurgeryLength)

# Remove negative values and outliers
surgery_patients <- surgery_patients %>% 
  na.omit() %>% 
  filter(SurgeryLength > 10) %>% 
  filter(SurgeryLength < 600) %>% 
  filter(PlannedTheatreTimeInMins > 10) %>% 
  filter(PlannedTheatreTimeInMins < 600)
```

```{r}
# Calculating Average Surgery Length by Age Group
AverageSurgeryLength_age <- surgery_patients %>% 
  group_by(AgeGroupAtDateOfRemoval) %>% 
  summarise(AverageSurgeryLength_age = round(mean(SurgeryLength, na.rm = TRUE))) %>% 
  arrange(desc(AverageSurgeryLength_age))

# Displaying the result
AverageSurgeryLength_age %>%
  kable("html", caption = "Average Surgery Length by Age Group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, "Average Length" = 1)) 

ggplot(AverageSurgeryLength_age, aes(x = AgeGroupAtDateOfRemoval, y = AverageSurgeryLength_age)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +
  geom_text(aes(label = AverageSurgeryLength_age), hjust = -0.2, color = "black", size = 3.5) +
  coord_flip() +
  labs(title = "Average Surgery Length by Age Group", 
       x = "Age Groups", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    plot.margin = ggplot2::margin(10, 10, 10, 10)
  )
```


```{r}
# Calculate the average of SurgeryLength by specialty
Average_surgery_length_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_by_specialty %>%
  kable("html", caption = "Average Surgery Length by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1))  

# Visualizing the result
ggplot(Average_surgery_length_by_specialty, aes(x = reorder(WaitingListSpecialtyDesc, -AverageSurgeryLength), y = AverageSurgeryLength)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +
  geom_text(aes(label = AverageSurgeryLength), hjust = -0.2, color = "black", size = 3.5) +
  coord_flip() +
  labs(title = "Average Surgery Length by Specialty", 
       x = "Specialty", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    plot.margin = ggplot2::margin(10, 10, 10, 10)
  )
```

Filter out Surgery within 10 hours, as the longer surgery requested more complex estimation.


```{r}
# Recheck
# Calculate average surgeons operating time
Average_surgery_length_surgeons <- surgery_patients %>%
  group_by(OperatingDrCarerName) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_surgeons %>%
  kable("html", caption = "Average Surgery Length by Surgeons") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```

```{r}
# Calculate average surgery length vs admin category
Average_surgery_length_admin <- surgery_patients %>%
  group_by(AdminCategory) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_admin %>%
  kable("html", caption = "Average Surgery Length by Admin Category") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 

# Visualizing the result
ggplot(Average_surgery_length_admin, aes(x = reorder(AdminCategory, -AverageSurgeryLength), y = AverageSurgeryLength)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +
  geom_text(aes(label = AverageSurgeryLength), hjust = -0.2, color = "black", size = 3.5) +
  coord_flip() +
  labs(title = "Average Surgery Length by Admin Category", 
       x = "Admin Category", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    plot.margin = ggplot2::margin(10, 10, 10, 10) 
  )
```

```{r}
# Calculate average surgery length vs Planned Stay
Average_surgery_length_plan_stay <- surgery_patients %>%
  group_by(PlannedStayTypeDescription) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_plan_stay %>%
  kable("html", caption = "Average Surgery Length by Planned Stay") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```

```{r}
# Calculate average surgery length by Treatment Campus
Average_surgery_length_treatment_campus <- surgery_patients %>%
  group_by(TreatmentCampusName) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_treatment_campus %>%
  kable("html", caption = "Average Surgery Length by Treament Campus") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 

# Visualizing the results
ggplot(Average_surgery_length_treatment_campus, aes(x = reorder(TreatmentCampusName, -AverageSurgeryLength), y = AverageSurgeryLength)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +
  geom_text(aes(label = AverageSurgeryLength), hjust = -0.2, color = "black", size = 3.5) +
  coord_flip() +
  labs(title = "Average Surgery Length by Treatment Campus", 
       x = "Treatment Campus", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    plot.margin = ggplot2::margin(10, 10, 10, 10)
  )

```
```{r}
# Calculate average surgery length by Treatment Campus
Average_surgery_length_priority <- surgery_patients %>%
  group_by(CurrentPriorityCode) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_priority %>%
  kable("html", caption = "Average Surgery Length by Priority Code") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 

# Visualizing the results
ggplot(Average_surgery_length_priority, aes(x = CurrentPriorityCode, y = AverageSurgeryLength)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +
  geom_text(aes(label = AverageSurgeryLength), hjust = -0.2, color = "black", size = 3.5) +
  coord_flip() +
  labs(title = "Average Surgery Length by Priority Code", 
       x = "Priority Code", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    plot.margin = ggplot2::margin(10, 10, 10, 10)
  )

```

```{r}
# Recheck
# Calculate average surgery length by PPPCode
Average_surgery_length_ppp <- surgery_patients %>%
  group_by(PPPCode) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_ppp %>%
  kable("html", caption = "Average Surgery Length by PPP code") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```


```{r}
# Recheck
# Calculate average surgery length by PPP Description
Average_surgery_length_ppp_desc <- surgery_patients %>%
  group_by(PPPDesc) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_ppp_desc %>%
  kable("html", caption = "Average Surgery Length by PPP decription") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```


```{r PPP Desc by group}
# Calculate average surgery length by PPP Description
Average_surgery_length_ppp_category <- surgery_patients %>%
  group_by(PPPCategory) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_ppp_category %>%
  kable("html", caption = "Average Surgery Length by PPP decription") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 

# Visualizing the result
ggplot(Average_surgery_length_ppp_category, aes(x = reorder(PPPCategory, -AverageSurgeryLength), y = AverageSurgeryLength)) +
  geom_bar(stat = "identity", fill = "#E69F00", width = 0.7) +  
  geom_text(aes(label = AverageSurgeryLength), hjust = -0.2, color = "black", size = 3.5) +  
  coord_flip() +  
  labs(title = "Average Surgery Length by PPP Category", 
       x = "PPP Category", 
       y = "Average Surgery Length (minutes)") +
  theme_minimal() +  # Clean theme
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.text.y = element_text(size = 12),  
    axis.title.y = element_text(size = 14),  
    axis.title.x = element_text(size = 14),  
    plot.margin = ggplot2::margin(10, 10, 10, 10)  
  )


```


```{r}
# Recheck
# Calculate average surgery length by PPP Group
Average_surgery_length_ppp_group <- surgery_patients %>%
  group_by(PppGroupID) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_ppp_group %>%
  kable("html", caption = "Average Surgery Length by PPP group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```

```{r}
# Recheck
# Calculate average surgery length by Refferal Type
Average_surgery_length_ref <- surgery_patients %>%
  group_by(ReferralType) %>%
  summarise(AverageSurgeryLength = round(mean(SurgeryLength, na.rm = TRUE)))%>% 
  arrange(desc(AverageSurgeryLength))

# Displaying the result
Average_surgery_length_ref %>%
  kable("html", caption = "Average Surgery Length by Referral Type") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1)) 
```


```{r}
# Recheck
# Calculating Waiting day variables and creating category for each group
surgery_patients <- surgery_patients %>%
  mutate(WaitingDays = as.numeric(round(difftime(SurgeryStartDateTime, WaitingStartDateTime, units = "days")))) %>%
  mutate(WaitingCategory = case_when(
    WaitingDays <= 30 ~ "Short",
    WaitingDays > 30 & WaitingDays <= 90 ~ "Medium",
    WaitingDays > 90 ~ "Long"
  ))

# Displaying the result
surgery_patients$WaitingCategory %>%
  head(10)
```

```{r}
# Proportion under 1 year by Specialty
proportion_within_1_year_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Proportion = round(mean(WaitingDays <= 365), 4))%>% 
  arrange(desc(Proportion))

proportion_within_1_year_by_specialty
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
# Proportion of people in waiting within 1 year
proportion_within_1_year <- surgery_patients %>%
  summarise(Proportion = round(mean(WaitingDays <= 365),4))

proportion_within_1_year
```

```{r}
# Average waiting time for particular Specialty
Average_waiting_day_by_specialty <- surgery_patients %>%
  group_by(WaitingListSpecialtyDesc) %>%
  summarise(Avearge_waiting_day = round(mean(WaitingDays)),
            CaseCount = n()) %>% 
  arrange(desc(Avearge_waiting_day))

# Displaying the result
Average_waiting_day_by_specialty %>%
  kable("html", caption = "Average Waiting Days by Specialty") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = FALSE, 
                font_size = 14) %>%
  column_spec(1, bold = TRUE, border_right = TRUE) %>%  
  column_spec(2, color = "blue", background = "lightgrey") %>% 
  add_header_above(c(" " = 1, " " = 1, " " = 1))  
```

```{r, eval = FALSE, echo = FALSE, warning=FALSE, message=FALSE}
# Count time patients has surgery
# Recheck
surgery_patients <- surgery_patients %>%
  group_by(WaitingListSourceIdentifier) %>%
  mutate(NumberOfSurgeries = n()) %>%
  ungroup()
```

# Exploratory Data Analysis (EDA)
## Checking the completeness of the data after clean
```{r}
p1 <- vis_dat(surgery_patients, `warn_large_data` = FALSE)

p2 <- vis_dat(waiting_patients, `warn_large_data` = FALSE)

plot_grid(p1, p2) 
```

```{r visualize, echo = FALSE, warning=FALSE, message=FALSE}
# Visualize the distribution of Planned Theatre Time
a <- ggplot(surgery_patients, aes(x = PlannedTheatreTimeInMins)) +
  geom_histogram(fill = "blue", color = "white", bins = 30) +
  theme_minimal() +
  labs(title = "Distribution of Planned Theatre Time in Minutes",
       x = "Planned Theatre Time (mins)")

# Visualize the distribution of Time Difference
b <- ggplot(surgery_patients, aes(x = SurgeryLength)) +
  geom_histogram( fill = "#E69F00", color = "white", bins = 30) +
  theme_minimal() +
  labs(title = "Distribution of Surgery Time in Minutes",
       x = "Operating Theatre Time (mins)")

gridExtra::grid.arrange(a, b)
```
**Insights**
Most case within range under 250, just a few outliers that are outside this range. Our goal is to improve this Planned Theatre Case.

```{r echo = FALSE, warning=FALSE, message=FALSE}
# Investigate relationships between Specialty and SurgeryLength
c <- ggplot() +
  # Add geom_line using the average surgery length by specialty
  geom_line(data = Average_surgery_length_by_specialty, aes(x = AverageSurgeryLength, 
                                               y = fct_reorder(WaitingListSpecialtyDesc, AverageSurgeryLength),
                                               group = 1), color = "blue", size = 1) +
   theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 55, hjust = 1)) +
  labs(title = "Average Surgery Length by Specialty",
       x = "Average Surgery Length (mins)",
       y = "Specialty")

# Boxplot of SurgeryLength with an additional geom_line for average
d <- ggplot(surgery_patients, aes(x = SurgeryLength, y = fct_reorder(WaitingListSpecialtyDesc, SurgeryLength, .fun = median))) +
  geom_boxplot(fill = "#E69F00") +
  
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 55, hjust = 1)) +
  labs(title = "Surgery Length by Specialty",
       x = "Surgery Length (mins)",
       y = "Specialty")

gridExtra::grid.arrange(c,d, ncol = 2)
```


```{r echo = FALSE, warning=FALSE, message=FALSE}
ggplot(proportion_within_1_year_by_specialty, aes(x = reorder(WaitingListSpecialtyDesc, Proportion), y = Proportion)) +
  geom_segment(aes(xend = reorder(WaitingListSpecialtyDesc, Proportion), y = 0, yend = Proportion), color = "grey") +
  geom_point(size = 5, color = "#E69F00") +
  theme_minimal() +
  labs(title = "Proportion of Patients Waiting Under 1 Year by Specialty",
       x = "Specialty",
       y = "Proportion") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))

# fpp3::autoplot(proportion_within_1_year_by_specialty)
```

```{r avg_waiting_day, echo = FALSE, warning=FALSE, message=FALSE}
p <- ggplot(Average_waiting_day_by_specialty, aes(x = reorder(WaitingListSpecialtyDesc, Avearge_waiting_day), y = Avearge_waiting_day)) +
  geom_segment(aes(xend = reorder(WaitingListSpecialtyDesc, Avearge_waiting_day), y = 0, yend = Avearge_waiting_day), color = "grey") +
  geom_point(aes(size = CaseCount), color = "#E69F00")  +
  theme_minimal() +
  labs(title = "Average Waiting Day by Specialty",
       x = "Specialty",
       y = "Avearge waiting day") +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))

plotly_plot <- ggplotly(p)

plotly_plot
```

## Plot relationship among predictors
```{r relationship plot, eval = FALSE}
surgery_data_plot <- surgery_patients %>%
  select(SurgeryLength, AgeGroupAtDateOfRemoval, CurrentPriorityCode, 
         WaitingListSpecialtyDesc, PPPDesc, TreatmentCampusName, AdminCategory)

# Plot the relationships using GGally::ggpairs
ggpairs(
  surgery_data_plot, 
  mapping = ggplot2::aes(color = AgeGroupAtDateOfRemoval), 
  cardinality_threshold = 30,
  lower = list(continuous = wrap("smooth", method = "lm", se = FALSE),  
               combo = wrap("facethist", bins = 10)),  
  diag = list(continuous = "densityDiag",  
              discrete = "barDiag"),  
  upper = list(continuous = wrap("cor", size = 3))  
)
# recheck
```

# Model fitting
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Get all levels of the factor from the entire dataset
all_levels <- levels(factor(surgery_patients$WaitingListSpecialtyDesc))

# Set the levels for the factor in the dataset
surgery_patients$WaitingListSpecialtyDesc <- factor(surgery_patients$WaitingListSpecialtyDesc, levels = all_levels)

# Training and Testing sets
# surgery_patients_split <- initial_split(surgery_patients,
#                                        2/3,
#                                        strata = WaitingListSpecialtyDesc)

# train_data <- training(surgery_patients_split)
# test_data <- testing(surgery_patients_split)

# Creating Cross validation folds
set.seed(123)
surgery_folds <- vfold_cv(surgery_patients, v = 5, strata = WaitingListSpecialtyDesc)
```
```{r recipe, eval = FALSE}
surgery_recipe <- recipe(SurgeryLength ~ AgeGroupAtDateOfRemoval + CurrentPriorityCode + WaitingListSpecialtyDesc +
                           NumberOfSurgeries + WaitingDays + WaitingCategory, data = train_data) %>%
  step_dummy(all_nominal_predictors()) %>%  # Convert factors to dummy variables
  step_normalize(all_numeric_predictors())  # Normalize numeric predictors for lm model
```

```{r}
# Fitting the model
# Linear Regression
lr_spec <- linear_reg() %>%
  set_engine("lm")

# Random Forest
rf_spec <- rand_forest(mtry = tune(), trees = 500, min_n = tune()) %>%
  set_engine("ranger") %>%
  set_mode("regression")

# Gradient Boosting
gbm_spec <- boost_tree(mtry = tune(), trees = 500, learn_rate = 0.01 #Controls how much each tree contributes to the final model in boosting algorithm
                       ) %>%
  set_engine("xgboost") %>%
  set_mode("regression")
```

```{r}
# Linear Regression Workflow
lr_workflow <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(surgery_recipe)

# Random Forest Workflow
rf_workflow <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(surgery_recipe)

# Gradient Boosting Workflow
gbm_workflow <- workflow() %>%
  add_model(gbm_spec) %>%
  add_recipe(surgery_recipe)
```

```{r}
# Setting Hyperparameters tune
# Random Forest Tuning Grid
rf_grid <- grid_regular(
  mtry(range = c(2, 10)),
  min_n(range = c(5, 15)),
  levels = 5
)

# Gradient Boosting Tuning Grid
gbm_grid <- grid_regular(
  mtry(range = c(2, 10)),
  levels = 5
)
```


```{r}
# Fit Linear Regression with Cross-Validation
lr_results <- fit_resamples(
  lr_workflow,
  resamples = surgery_folds,
  metrics = metric_set(rmse),
  control = control_resamples(save_pred = TRUE)
)


# Tune Random Forest Model
rf_results <- tune_grid(
  rf_workflow,
  resamples = surgery_folds,
  grid = rf_grid,
  metrics = metric_set(rmse),
  control = control_grid(save_pred = TRUE)
)

# Select Best Hyperparameters
best_rf <- select_best(rf_results, "rmse")

# Finalize Workflow with Best Hyperparameters
final_rf_workflow <- finalize_workflow(rf_workflow, best_rf)

# Tune Gradient Boosting Model
gbm_results <- tune_grid(
  gbm_workflow,
  resamples = surgery_folds,
  grid = gbm_grid,
  metrics = metric_set(rmse),
  control = control_grid(save_pred = TRUE)
)

# Select Best Hyperparameters
best_gbm <- select_best(gbm_results, "rmse")

# Finalize Workflow with Best Hyperparameters
final_gbm_workflow <- finalize_workflow(gbm_workflow, best_gbm)

```

```{r}
# Collect RMSE Metrics
lr_rmse <- lr_results %>% collect_metrics()
rf_rmse <- rf_results %>% collect_metrics()
gbm_rmse <- gbm_results %>% collect_metrics()
```

```{r}
# Combine RMSE Results
rmse_results <- bind_rows(
  lr_rmse %>% mutate(Model = "Linear Regression"),
  rf_rmse %>% mutate(Model = "Random Forest"),
  gbm_rmse %>% mutate(Model = "Gradient Boosting")
)

# View RMSE Comparison
rmse_results %>%
  select(Model, .metric, mean, std_err) %>%
  arrange(mean) %>%
  kable("html", caption = "Model RMSE Comparison") %>%
  kable_styling(full_width = FALSE)
```

```{r old_one}
# Temporarily error, recheck
#Recheck
surgery_metrics_wide <- surgery_metrics %>% 
  select(id, log_metrics, ridge_metrics, lasso_metrics, rf_metrics, gbm_metrics) %>% 
  unnest(cols = c(log_metrics, ridge_metrics, lasso_metrics, rf_metrics, gbm_metrics), names_sep = "_") %>%
  
  pivot_longer(cols = starts_with("reg_metrics_"), names_to = "metric", names_prefix = "reg_metrics_", values_to = "reg") %>%
  pivot_longer(cols = starts_with("ridge_metrics_"), names_to = "metric", names_prefix = "ridge_metrics_", values_to = "ridge") %>%
  pivot_longer(cols = starts_with("lasso_metrics_"), names_to = "metric", names_prefix = "lasso_metrics_", values_to = "lasso") %>%
  pivot_longer(cols = starts_with("rf_metrics_"), names_to = "metric", names_prefix = "rf_metrics_", values_to = "rf") %>%
  pivot_longer(cols = starts_with("gbm_metrics_"), names_to = "metric", names_prefix = "gbm_metrics_", values_to = "gbm") %>%
  pivot_longer(cols = c(log, ridge, lasso, rf, gbm), names_to = "model", values_to = "value") %>%
  pivot_wider(names_from = metric, values_from = value)

# Calculate average metrics across folds for each model
surgery_results <- surgery_metrics_wide %>% 
  group_by(model) %>% 
  summarize(
    rmse = mean(rmse, na.rm = TRUE),
    mae = mean(mae, na.rm = TRUE),
    mape = mean(mape, na.rm = TRUE),
    rsq = mean(rsq, na.rm = TRUE)
  )

print(surgery_results)
```

